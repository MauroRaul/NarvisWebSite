<!doctype html>
<html lang="it">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NARVIS - L'Ambiente di Scrittura di Nuova Generazione</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        "neu-base": "#2D3748",
                        "neu-base-dark": "#1A202C",
                        "neu-text": "#F7FAFC",
                        "neu-text-light": "#A0AEC0",
                        "neu-accent": "#8B5CF6",
                        "neu-accent-hover": "#7C3AED",
                        "neu-danger": "#EF4444",
                        "neu-success": "#10B981",
                        "neu-warning": "#FBBF24",
                    },
                    fontFamily: {
                        sans: ["Nunito", "ui-sans-serif", "system-ui"],
                        mono: ['"Courier Prime"', "ui-monospace", "SFMono-Regular"],
                    },
                    animation: {
                        marquee: "marquee 40s linear infinite",
                    },
                    keyframes: {
                        marquee: {
                            "0%": { transform: "translateX(0%)" },
                            "100%": { transform: "translateX(-50%)" },
                        },
                    },
                },
            },
        };
    </script>
</head>

<body class="bg-neu-base text-neu-text antialiased min-h-screen flex flex-col items-center">
    <!-- Header / Navbar Minimal -->
    <header class="w-full max-w-6xl flex items-center justify-between px-6 py-8">
        <a href="/" class="flex items-center">
            <img src="LogoHorizontal_Alpha.png" alt="Narvis Logo" class="h-8 md:h-10 w-auto" />
        </a>
        <nav class="hidden md:flex gap-8 text-sm font-semibold text-neu-text-light">
            <a href="#features" class="hover:text-neu-accent transition-colors">Architettura</a>
            <a href="#intelligence" class="hover:text-neu-accent transition-colors">Intelligenza</a>
            <a href="#studio" class="hover:text-neu-accent transition-colors">Studio Virtuale</a>
        </nav>
        <button id="header-login-btn"
            class="px-6 py-2 rounded-xl font-bold text-neu-text transition-all shadow-neu-out hover:text-neu-accent active:shadow-neu-in text-xs hidden md:block border border-transparent">
            Accedi
        </button>
    </header>

    <!-- Hero Section -->
    <main class="w-full flex-grow flex flex-col items-center justify-center container mx-auto px-4 mt-12 mb-32">
        <div class="max-w-4xl w-full flex flex-col items-center text-center space-y-12">
            <!-- Graphic Element: Simula la battitura a macchina incassata -->
            <div
                class="w-full max-w-2xl bg-neu-base shadow-neu-in rounded-3xl p-6 md:p-8 flex items-center justify-center relative overflow-hidden h-32 md:h-40">
                <!-- Text that disappears -->
                <div id="hero-typing-text"
                    class="font-mono text-neu-text-light opacity-80 text-sm md:text-lg absolute transition-opacity duration-1000">
                    INT. CAMERA DEL PROTAGONISTA - NOTTE
                    <br /><br />
                    La parola fine...<span class="animate-pulse">_</span>
                </div>
                <!-- UI Interface that fades in -->
                <div id="hero-ui-element" class="opacity-0 transition-opacity duration-1000 absolute w-3/4 flex gap-4">
                    <div class="flex-grow shadow-neu-in rounded-xl p-3 flex items-center">
                        <div class="h-2 w-1/2 bg-neu-accent rounded-full opacity-50 ai-typing"></div>
                    </div>
                </div>
            </div>

            <div class="space-y-6 max-w-3xl">
                <h1 class="text-5xl md:text-7xl font-extrabold leading-tight tracking-tight text-white drop-shadow-lg">
                    Il posto in cui le storie pi√π complesse prendono forma.
                </h1>
                <p class="text-lg md:text-xl text-neu-text-light font-semibold max-w-2xl mx-auto px-4">
                    Non il solito programma di scrittura. Il primo ambiente sviluppato
                    per orchestrare le tue storie, controllare la coerenza narrativa
                    passo dopo passo e dare vita a mondi interi.
                </p>
            </div>

            <div class="flex flex-col sm:flex-row gap-6 mt-4 w-full justify-center px-4">
                <button id="hero-cta-btn"
                    class="w-full sm:w-auto px-10 py-5 rounded-2xl font-extrabold text-neu-accent shadow-neu-out hover:shadow-neu-in active:shadow-neu-in transition-all text-sm uppercase tracking-wide text-center">
                    Richiedi Accesso Anticipato
                </button>
            </div>
        </div>
    </main>

    <!-- Infinite Marquee Features -->
    <div class="w-full overflow-hidden bg-neu-base-dark py-6 shadow-neu-in border-y border-white/5 relative cursor-grab active:cursor-grabbing"
        id="features-carousel-container">
        <!-- Gradiente ai bordi per sfumare l'ingresso/uscita -->
        <div
            class="absolute inset-y-0 left-0 w-16 md:w-32 bg-gradient-to-r from-neu-base-dark to-transparent z-10 pointer-events-none">
        </div>
        <div
            class="absolute inset-y-0 right-0 w-16 md:w-32 bg-gradient-to-l from-neu-base-dark to-transparent z-10 pointer-events-none">
        </div>

        <div id="features-marquee"
            class="flex w-max animate-marquee hover:[animation-play-state:paused] transition-all">
            <!-- Set 1 -->
            <div class="flex gap-6 px-3">
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">‚òÅÔ∏è</span> Salvataggio Google Drive
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">‚è±Ô∏è</span> Versioning Indietro nel
                    Tempo
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">‚ö°</span> Audit Coerenza IA
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üó∫Ô∏è</span> World Building Spaziale
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üë•</span> Database Personaggi Dinamico
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üìà</span> Generatore Timeline
                    Automatica
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üõ°Ô∏è</span> Rilevatore Paradossi
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üé¨</span> Storyboard Visivo
                    Interattivo
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üìÑ</span> Esportazione PDF
                    Intelligente
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üåô</span> Editor Zen Anti-Distrazione
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üîó</span> Grafi di Trama Complessi
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üîç</span> Analisi Semantica Profonda
                </div>
            </div>
            <!-- Set 2 (Identico per loop continuo) -->
            <div class="flex gap-6 px-3">
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">‚òÅÔ∏è</span> Salvataggio Google Drive
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">‚è±Ô∏è</span> Versioning Indietro nel
                    Tempo
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">‚ö°</span> Audit Coerenza IA
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üó∫Ô∏è</span> World Building Spaziale
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üë•</span> Database Personaggi Dinamico
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üìà</span> Generatore Timeline
                    Automatica
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üõ°Ô∏è</span> Rilevatore Paradossi
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üé¨</span> Storyboard Visivo
                    Interattivo
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üìÑ</span> Esportazione PDF
                    Intelligente
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üåô</span> Editor Zen Anti-Distrazione
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üîó</span> Grafi di Trama Complessi
                </div>
                <div
                    class="flex items-center gap-2 bg-neu-base px-6 py-3 rounded-full shadow-neu-out text-neu-text text-sm font-bold whitespace-nowrap border border-white/5">
                    <span class="text-neu-accent">üîç</span> Analisi Semantica Profonda
                </div>
            </div>
        </div>
    </div>

    <!-- Sezione La struttura perfetta -->
    <section id="features"
        class="w-full max-w-6xl mx-auto px-6 py-20 flex flex-col md:flex-row items-center gap-16 relative">
        <div class="md:w-1/2 space-y-8">
            <h2 class="text-4xl md:text-5xl font-extrabold text-white leading-tight">
                La struttura perfetta.
            </h2>
            <p class="text-lg text-neu-text-light font-semibold">
                Il tuo intreccio non √® lineare. Perch√© dovrebbe esserlo il tuo
                strumento di scrittura?
            </p>
            <p class="text-neu-text leading-relaxed relative">
                Nodi, archi, cause ed effetti. Muovi un tassello e l'universo
                narrativo si riallinea automaticamente. Una visione spaziale della
                trama affiancata al testo, per padroneggiare opere complesse senza mai
                perdere il filo.
            </p>

            <!-- Wow Text a comparsa -->
            <div id="wow-description-box"
                class="overflow-hidden transition-all duration-[1500ms] ease-in-out max-h-0 opacity-0 mt-4 rounded-xl border border-neu-accent/30 bg-neu-accent/5 p-0">
                <div class="p-6">
                    <p class="text-neu-text leading-relaxed text-sm md:text-base italic">
                        Con lo Storyline non organizzi semplici capitoli: costruisci
                        <strong class="text-neu-accent">nodi narrativi</strong> collegati
                        da relazioni logiche e causali.<br />
                        √à qui che nasce la vera
                        <strong class="text-neu-accent">nidificazione</strong>: un
                        capitolo si espande in episodi, un episodio si scompone nei suoi
                        dettagli essenziali.<br /><br />
                        Il risultato √® una struttura
                        <strong class="text-neu-accent">profonda e dinamica</strong>,
                        capace di rendere visibile l‚Äôarchitettura dell‚Äôintreccio e di
                        mantenerla coerente nel tempo.<br /><br />
                        NARVIS non √® solo un programma di scrittura<br />
                        √à un ambiente che comprende la tua storia, ne preserva la coerenza
                        e la fa evolvere insieme a te.
                    </p>
                </div>
            </div>
        </div>

        <div id="storyline-workspace"
            class="md:w-1/2 w-full relative h-[400px] flex items-center justify-center overflow-visible select-none">
            <!-- SVG Canvas for dynamic drawing -->
            <svg id="storyline-svg"
                class="absolute inset-0 w-full h-full pointer-events-none z-0 transition-opacity duration-[2000ms]"
                style="overflow: visible">
                <!-- Initial static line will be drawn here by JS on load -->
            </svg>

            <!-- Container Astratto Passato / Futuro (Invisibile di base) - GRIGLIA A 9 NODI -->
            <div id="abstract-graph-overlay"
                class="absolute inset-0 w-full h-full z-40 flex items-center justify-between px-10 pointer-events-none opacity-0 transition-all duration-[2000ms] scale-75">
                <!-- Zona Passato (4 Nodi in struttura ad albero sx) -->
                <div class="flex flex-col items-end gap-2 relative w-1/3 h-full justify-center">
                    <span
                        class="absolute top-10 left-0 text-neu-text-light font-bold tracking-widest uppercase text-sm opacity-50">Passato</span>

                    <!-- Ramo Superiore -->
                    <div class="flex items-center gap-2 translate-x-4">
                        <div
                            class="w-12 h-6 rounded-full border border-white/5 bg-neu-base-dark shadow-neu-in-sm flex items-center justify-center opacity-70">
                            <div class="w-1.5 h-1.5 rounded-full bg-cyan-500/30"></div>
                        </div>
                        <div class="w-6 h-px bg-cyan-500/20"></div>
                        <div
                            class="w-16 h-8 rounded-full border border-white/10 bg-neu-base-dark shadow-neu-in-sm flex items-center justify-center">
                            <div class="w-2 h-2 rounded-full bg-green-500/50"></div>
                        </div>
                    </div>

                    <!-- Linee di connessione centrali -->
                    <div class="absolute right-[5.5rem] top-1/2 -translate-y-1/2 w-px h-16 bg-cyan-500/20"></div>

                    <!-- Nodo Centrale asse principale -->
                    <div class="flex items-center gap-2 mt-2">
                        <div
                            class="w-10 h-6 rounded-full border border-white/5 bg-neu-base-dark shadow-neu-in-sm flex items-center justify-center opacity-50">
                            <div class="w-1.5 h-1.5 rounded-full border border-cyan-500/30"></div>
                        </div>
                        <div class="w-10 h-px bg-cyan-500/20"></div>
                        <div
                            class="w-20 h-8 rounded-full border border-white/10 bg-neu-base shadow-neu-out flex items-center justify-end px-3">
                            <div class="w-2 h-2 rounded-full bg-cyan-500"></div>
                        </div>
                    </div>

                    <!-- Ramo Inferiore -->
                    <div class="flex items-center gap-2 mt-2 translate-x-8 opacity-80">
                        <div class="w-8 h-px bg-cyan-500/20"></div>
                        <div
                            class="w-12 h-6 rounded-full border border-white/10 bg-neu-base-dark shadow-neu-in-sm flex items-center justify-center">
                            <div class="w-1.5 h-1.5 rounded-full border border-purple-500/40"></div>
                        </div>
                    </div>
                </div>

                <!-- Connessione Centrale -->
                <div
                    class="flex-1 max-w-[80px] h-px bg-gradient-to-r from-cyan-500 via-white/20 to-purple-500 mx-4 opacity-50">
                </div>

                <!-- Zona Futuro (5 Nodi in struttura ad albero dx) -->
                <div class="flex flex-col items-start gap-3 relative w-1/3 h-full justify-center">
                    <span
                        class="absolute top-10 right-0 text-neu-text-light font-bold tracking-widest uppercase text-sm opacity-50">Futuro</span>

                    <!-- Ramo Superiore -->
                    <div class="flex items-center gap-2 translate-x-4">
                        <div
                            class="w-24 h-8 rounded-full border border-white/10 bg-neu-base-dark flex items-center px-4 justify-between shadow-neu-in-sm">
                            <div class="w-2 h-2 rounded-full bg-purple-500/50"></div>
                            <div class="h-1 w-8 bg-white/5 rounded-full"></div>
                        </div>
                        <div class="w-4 h-px bg-purple-500/20"></div>
                        <div
                            class="w-10 h-6 rounded-full border border-white/5 bg-neu-base-dark flex items-center justify-center shadow-neu-in-sm opacity-60">
                            <div class="w-1.5 h-1.5 rounded-full border border-purple-500/30"></div>
                        </div>
                    </div>

                    <!-- Linee di diramazione centrali dx -->
                    <div class="absolute left-8 top-1/2 -translate-y-1/2 w-px h-24 bg-purple-500/20 -z-10"></div>

                    <!-- Nodo Centrale asse principale -->
                    <div class="flex items-center gap-2">
                        <div
                            class="w-16 h-8 rounded-full border border-neu-accent/30 flex items-center justify-center shadow-neu-out bg-neu-base relative">
                            <div
                                class="w-2.5 h-2.5 rounded-full bg-neu-accent animate-pulse shadow-[0_0_10px_rgba(6,182,212,0.8)]">
                            </div>
                        </div>
                        <div class="w-12 h-px bg-purple-500/20"></div>
                        <div
                            class="w-14 h-6 rounded-full border border-white/5 bg-neu-base-dark flex items-center justify-center shadow-neu-in-sm opacity-60">
                            <div class="w-1 h-1 rounded-full bg-purple-500/30"></div>
                        </div>
                    </div>

                    <!-- Ramo Inferiore -->
                    <div class="flex items-center gap-2 -translate-x-2">
                        <div class="w-6 h-px bg-purple-500/20"></div>
                        <div
                            class="w-16 h-8 rounded-full border border-white/10 bg-neu-base-dark flex items-center justify-center shadow-neu-in-sm">
                            <div class="w-2 h-2 rounded-full bg-green-500/40"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Wrapper Animato: Card Elemento Sceneggiatura -->
            <div class="absolute left-0 z-10 w-2/3 node-element transition-all duration-[2000ms] ease-in-out"
                id="source-chapter-node">
                <!-- VERO COMPONENTE STORYLINE PANEL: STORY NODE (CHAPTER) -->
                <div
                    class="rounded-xl flex flex-col group shadow-neu-in border border-white/20 ring-2 ring-neu-accent bg-[rgba(224,229,236,0.1)] relative w-full h-40 transition-all duration-[2000ms]">
                    <div
                        class="absolute top-0 left-0 w-full h-5 z-0 rounded-t-xl overflow-hidden pointer-events-none border-b border-white/20 shadow-sm bg-neu-text">
                        <div class="absolute inset-0 w-full h-full" style="
                  background-image: repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 10px,
                    rgba(255, 255, 255, 0.2) 10px,
                    rgba(255, 255, 255, 0.2) 20px
                  );
                "></div>
                    </div>
                    <div
                        class="absolute -top-3 left-4 bg-neu-accent text-white text-[9px] font-bold px-3 py-0.5 rounded-full shadow-lg z-40 tracking-widest border border-white/20 flex items-center gap-1 pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                        </svg>
                        CHAPTER
                    </div>
                    <div
                        class="absolute top-0 left-0 bg-neu-base shadow-neu-out rounded-br-2xl border-r border-b border-white/20 z-20 px-4 py-1.5 flex items-center space-x-2 mt-5">
                        <h4 class="font-extrabold text-neu-text text-xs uppercase truncate">
                            Capitolo 12 - Il Nautilus
                        </h4>
                    </div>
                    <!-- Nodi di Connessione -->
                    <div class="connection-port absolute w-4 h-4 bg-green-500 rounded-full z-30 hover:scale-125 hover:opacity-100 transition-transform"
                        data-port-color="#22c55e" style="left: -6px; top: 40%"></div>
                    <!-- Porta di connessione interattiva con visual cue (pulse) -->
                    <div class="connection-port animate-pulse connection-port-right absolute w-4 h-4 bg-cyan-500 rounded-full z-30 cursor-crosshair hover:scale-125 hover:opacity-100 transition-transform shadow-[0_0_10px_rgba(6,182,212,0.8)]"
                        data-port-color="#06b6d4" style="right: -6px; top: 40%" title="Trascina per connettere">
                        <!-- Tooltip Visuale Pulsante -->
                        <div
                            class="absolute -top-8 left-1/2 -translate-x-1/2 whitespace-nowrap bg-neu-text text-neu-base text-[10px] font-bold px-2 py-1 rounded shadow-lg pointer-events-none opacity-80 animate-bounce">
                            Trascina
                        </div>
                    </div>
                    <div class="connection-port absolute w-4 h-4 bg-purple-500 rounded-full z-30 hover:scale-125 hover:opacity-100 transition-transform"
                        data-port-color="#a855f7" style="left: -6px; top: 70%"></div>
                    <div class="connection-port absolute w-4 h-4 bg-purple-500 rounded-full z-30 hover:scale-125 hover:opacity-100 transition-transform"
                        data-port-color="#a855f7" style="right: -6px; top: 70%"></div>

                    <div
                        class="p-3 h-full flex flex-col items-start justify-center pt-16 px-6 relative z-10 opacity-70">
                        <div class="h-2 w-full bg-neu-base-dark rounded-full mb-3 shadow-neu-in-sm"></div>
                        <div class="h-2 w-5/6 bg-neu-base-dark rounded-full shadow-neu-in-sm"></div>
                    </div>
                    <div
                        class="absolute top-full left-1/2 -translate-x-1/2 h-5 w-12 bg-neu-base shadow-neu-out rounded-b-xl border-x border-b border-white/20 z-40 flex items-center justify-center -mt-[1px]">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"
                            class="text-neu-text-light">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- MARUKUS REMOVED -->
        </div>
    </section>


    <!-- Sezione World Building e Regia Visiva (Dark Cartography) -->
    <section id="studio" class="w-full max-w-6xl mx-auto px-6 py-32 flex flex-col items-center text-center gap-10">
        <div class="space-y-6 max-w-3xl">
            <h2 class="text-4xl md:text-5xl font-extrabold text-white leading-tight">
                Plasma la geografia della tua storia.
            </h2>
            <p class="text-lg text-neu-text-light font-semibold">
                In NARVIS lo spazio non √® una decorazione, √® il fondamento fisico del tuo racconto.
                Importa uno schizzo, una geometria astratta o una foto: trasformali in materiale vivo.
            </p>
        </div>

        <!-- Tech Demo World Builder: Uploader + Generatore -->
        <!-- Sfondo Dark Sepia (stone-900) con bordo color rame leggero -->
        <div
            class="w-full max-w-5xl bg-stone-900/95 backdrop-blur rounded-3xl p-6 md:p-10 shadow-[inset_0px_2px_15px_rgba(0,0,0,0.8),_0_10px_30px_rgba(0,0,0,0.5)] border border-amber-900/40 mx-auto relative mt-4 overflow-hidden">

            <!-- Grid Pattern Leggero per mood topografico/architettonico -->
            <div class="absolute inset-0 z-0 opacity-10 pointer-events-none"
                style="background-image: radial-gradient(circle at 2px 2px, #f59e0b 1px, transparent 0); background-size: 32px 32px;">
            </div>

            <div class="flex flex-col md:flex-row gap-10 items-start w-full relative z-10">

                <!-- Colonna Sinistra (Copy e Features) -->
                <div class="w-full md:w-5/12 text-left flex flex-col justify-center h-full">
                    <h3 class="text-xl font-bold text-white mb-4">La topografia non √® una tela bianca.</h3>
                    <p class="text-sm text-stone-300 mb-6 leading-relaxed">
                        Ogni elemento del mondo diventa parte del sistema. Costruisci le mura del tuo universo o
                        progetta interi emisferi interconnessi:
                    </p>
                    <ul class="space-y-4 mb-8">
                        <li class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-amber-500 mt-0.5 mr-3 shrink-0"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7" />
                            </svg>
                            <span class="text-sm font-semibold text-white">Cartografia in scala reale</span>
                        </li>
                        <li class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-amber-500 mt-0.5 mr-3 shrink-0"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
                            </svg>
                            <span class="text-sm font-semibold text-white">Gestione delle distanze esatte</span>
                        </li>
                        <li class="flex items-start">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-amber-500 mt-0.5 mr-3 shrink-0"
                                fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            <span class="text-sm font-semibold text-white">Evoluzione visiva guidata dall‚ÄôAI</span>
                        </li>
                    </ul>
                    <p class="text-xs text-amber-500 italic font-medium mt-auto">
                        Mettilo alla prova. Carica il tuo tracciato o un tuo schizzo, decidi l'atmosfera e lascia che
                        l'AI gli dia consistenza.
                    </p>
                </div>

                <!-- Colonna Destra (Interactive Demo) -->
                <div class="w-full md:w-7/12 flex flex-col justify-center gap-4">
                    <!-- Zona Immagine / Splitter -->
                    <div class="w-full rounded-2xl overflow-hidden relative shadow-[inset_0_2px_10px_rgba(0,0,0,0.8)] border border-stone-800 aspect-video bg-black flex items-center justify-center group"
                        id="wb-image-container">
                        <!-- Area Upload Iniziale stile Blueprint -->
                        <label id="wb-upload-area"
                            class="absolute inset-4 z-20 flex flex-col items-center justify-center cursor-pointer transition-colors duration-300 hover:bg-white/5 border-2 border-dashed border-stone-700 rounded-xl bg-stone-900/50">
                            <input type="file" id="wb-file-input" accept="image/*" class="hidden" />
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-stone-500 mb-3" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                            </svg>
                            <p class="text-stone-300 font-bold text-sm uppercase tracking-widest">
                                Traccia la prima linea
                            </p>
                            <p class="text-stone-500 text-[10px] mt-1">
                                Clicca per inserire la tua mappa / sketch
                            </p>
                        </label>

                        <!-- Loader Magia AI -->
                        <div id="wb-loader"
                            class="absolute inset-0 z-40 bg-black/80 backdrop-blur-sm hidden flex-col items-center justify-center">
                            <div
                                class="w-12 h-12 border-4 border-amber-900/40 border-t-amber-500 rounded-full animate-spin mb-4">
                            </div>
                            <p class="text-amber-500 text-xs font-bold uppercase tracking-widest animate-pulse">
                                Sintesi morfologica in corso...
                            </p>
                        </div>

                        <!-- Splitter Before/After contenitore (Inizialmente nascosto) -->
                        <div id="wb-splitter-stage"
                            class="absolute inset-0 w-full h-full hidden overflow-hidden select-none">
                            <!-- Immagine BEFORE (Sketch originale) - Base layer -->
                            <img id="wb-before-img" class="absolute inset-0 w-full h-full object-cover object-center"
                                src="" alt="Sketch originale" />

                            <!-- Immagine AFTER (Render finale AI) - Clip layer -->
                            <div id="wb-after-wrapper" class="absolute inset-0 w-full h-full overflow-hidden"
                                style="width: 50%">
                                <img id="wb-after-img" class="absolute top-0 left-0 h-full object-cover object-center"
                                    style="width: var(--wb-container-width, 100%); max-width: none;" src=""
                                    alt="Render AI" />
                            </div>

                            <!-- Slider Handle (Hit-box allargata per Mobile) -->
                            <div id="wb-slider-handle"
                                class="absolute top-0 bottom-0 w-12 cursor-ew-resize z-30 flex items-center justify-center transform -translate-x-1/2 touch-none"
                                style="left: 50%">
                                <!-- Linea visibile -->
                                <div
                                    class="absolute inset-y-0 w-1 bg-amber-500/80 shadow-[0_0_10px_rgba(245,158,11,0.5)] pointer-events-none">
                                </div>
                                <!-- Pallino visibile -->
                                <div
                                    class="w-8 h-8 rounded-full bg-amber-500 text-black shadow-lg flex items-center justify-center pointer-events-none z-10">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                                        fill="currentColor">
                                        <path fill-rule="evenodd"
                                            d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.414-1.414H10a1 1 0 010-2h4.586l-1.414-1.414zM10 4a1 1 0 00-1 1v4H5.414l1.293-1.293a1 1 0 10-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L5.414 11H9v4H5.414l1.293-1.293a1 1 0 00-1.414-1.414l-3 3a1 1 0 000 1.414l3 3a1 1 0 001.414-1.414L5.414 19H10a1 1 0 001-1V5a1 1 0 00-1-1z"
                                            clip-rule="evenodd" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Controlli generazione -->
                    <div class="space-y-3 relative z-10 w-full mt-2">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] font-black text-stone-400 uppercase tracking-widest pl-1">Veste
                                Visiva / Stile</label>
                            <span id="wb-uses-badge"
                                class="px-2 py-0.5 rounded bg-black/50 shadow-inner text-amber-500 text-[9px] font-bold uppercase tracking-widest border border-amber-900/30">2/2
                                Tentativi</span>
                        </div>
                        <input type="text" id="wb-prompt-input"
                            placeholder="Es: Antica mappa stellare, Foresta luminescente..."
                            value="Mappa fantasy dipinta a mano, dettagli geografici complessi, pergamena logora"
                            class="w-full bg-black/40 shadow-inner rounded-xl px-4 py-3 text-sm text-stone-200 border border-stone-800 focus:outline-none focus:ring-2 focus:ring-amber-500/50 transition-all font-mono placeholder:text-stone-600" />

                        <button id="wb-generate-btn"
                            class="w-full py-4 mt-2 bg-gradient-to-r from-amber-600 to-amber-500 text-stone-900 rounded-xl text-xs font-black uppercase shadow-[0_5px_15px_rgba(245,158,11,0.2)] hover:shadow-[0_8px_25px_rgba(245,158,11,0.4)] hover:-translate-y-0.5 active:translate-y-0 transition-all border border-amber-400/30">
                            Sintetizza Visuale
                        </button>

                        <div id="wb-signup-prompt"
                            class="hidden text-center text-[10px] text-stone-300 font-medium bg-black/50 p-3 rounded-lg border border-red-500/20 mt-2">
                            Token esauriti.
                            <a href="#" class="text-amber-500 font-bold hover:underline"
                                onclick="event.preventDefault(); document.getElementById('hero-cta-btn').click();">Richiedi
                                l'accesso</a>
                            per sbloccare gli strumenti architettonici completi.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Sezione Il Guardiano della Coerenza (Spostata dalla sua posizione originale) -->
    <section id="intelligence" class="w-full bg-neu-base-dark mt-20 py-24 shadow-neu-in">
        <div class="max-w-6xl mx-auto px-6 flex flex-col md:flex-row-reverse items-center gap-16">
            <div class="md:w-1/2 space-y-8">
                <div
                    class="inline-flex max-w-max items-center justify-center gap-2 px-4 py-2 bg-neu-base rounded-full shadow-neu-out text-neu-accent text-xs font-bold tracking-widest uppercase">
                    <span class="w-2 h-2 rounded-full bg-neu-accent animate-ping"></span>
                    Live auditing
                </div>
                <h2 class="text-4xl md:text-5xl font-extrabold text-white leading-tight">
                    Il Guardiano della Coerenza.
                </h2>
                <p class="text-lg text-neu-text-light font-semibold">
                    Zero buchi di trama. Continuit√† assoluta.
                </p>
                <p class="text-neu-text leading-relaxed">
                    Un'intelligenza artificiale architettonica lavora in background. Non
                    scrive per te elabora gli eventi, monitora i possedimenti dei
                    personaggi e rileva i paradossi prima ancora che si trasformino in
                    errori critici. Il tuo specchio revisionale invisibile.
                </p>
            </div>

            <div class="md:w-1/2 w-full flex justify-center">
                <!-- VERO COMPONENTE REVISION STUDIO: CRUSCOTTO DIAGNOSTICO & HOVER ALERT -->
                <div class="w-full max-w-sm relative">
                    <!-- Hover Alert Modal (Paradosso/Conflitto) -->
                    <div
                        class="relative z-20 w-full p-5 rounded-[24px] backdrop-blur-xl border shadow-2xl bg-red-50/90 border-red-500/50 mb-6 transform -translate-y-4 hover:translate-y-0 transition-transform duration-500">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="text-[10px] font-black text-neu-accent uppercase tracking-widest">
                                    Markus
                                </h4>
                                <p class="text-[9px] font-bold text-neu-text-light uppercase italic">
                                    Cap. SCENA 01
                                </p>
                            </div>
                            <div
                                class="px-2 py-0.5 rounded text-[8px] font-black uppercase shadow-sm bg-red-500 text-white">
                                Conflitto (Paradosso)
                            </div>
                        </div>

                        <div class="space-y-3">
                            <!-- Inventario & Luogo -->
                            <div class="bg-black/5 rounded-xl p-3 border border-black/5">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs">üìç</span>
                                    <span class="text-[11px] font-bold text-neu-text">Auto di Markus</span>
                                </div>
                                <div class="flex flex-wrap gap-1.5 border-t border-black/5 pt-2">
                                    <span
                                        class="text-[9px] bg-white/60 px-2 py-0.5 rounded-md border border-white/40 text-neu-text font-medium">
                                        üéí Chiavi dell'auto
                                    </span>
                                </div>
                            </div>

                            <!-- Diagnosi AI -->
                            <div class="pt-2">
                                <label
                                    class="text-[9px] font-black text-neu-text-light uppercase tracking-widest block mb-1">Diagnosi
                                    Narrativa</label>
                                <p class="text-[11px] text-neu-text leading-relaxed font-medium italic">
                                    Markus usa le chiavi dell'auto in questa scena, ma nel
                                    capitolo precedente le aveva dichiaratamente dimenticate
                                    nella stanza del motel.
                                </p>
                            </div>

                            <!-- Action Button Fix -->
                            <div class="mt-3 pt-3 border-t border-red-500/10 flex flex-col gap-2">
                                <p
                                    class="text-[10px] text-red-700 font-bold uppercase tracking-tighter flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span>
                                    Incongruenza Rilevata
                                </p>
                                <button
                                    class="w-full py-2 bg-red-600 text-white rounded-xl text-[10px] font-black uppercase shadow-lg hover:brightness-110 transition-all flex items-center justify-center gap-2">
                                    üõ†Ô∏è FIX AI
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cruscotto Diagnostico Barra -->
                    <div
                        class="p-4 border border-white/10 bg-neu-base shadow-md rounded-2xl z-10 flex flex-col gap-3 transform translate-y-4 hover:-translate-y-0 transition-transform duration-500">
                        <h3 class="font-bold text-neu-text text-xs uppercase tracking-widest text-center">
                            Matrice di Continuit√†
                        </h3>
                        <div
                            class="flex flex-wrap justify-center gap-3 text-[9px] font-bold uppercase tracking-tighter">
                            <div class="flex items-center">
                                <div class="w-2.5 h-2.5 rounded-sm bg-neu-text-light/20 mr-1.5 border border-white/20">
                                </div>
                                Coerente
                            </div>
                            <div class="flex items-center">
                                <div class="w-2.5 h-2.5 rounded-sm bg-blue-500/20 mr-1.5 border border-blue-500/40">
                                </div>
                                Evoluzione
                            </div>
                            <div class="flex items-center">
                                <div class="w-2.5 h-2.5 rounded-sm bg-red-500 mr-1.5 shadow-[0_0_5px_red]"></div>
                                Paradosso
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer / Waitlist -->
    <footer
        class="w-full bg-neu-base-dark py-24 shadow-neu-in rounded-t-[60px] flex flex-col items-center text-center px-4 mt-10">
        <div class="max-w-2xl w-full space-y-12">
            <h2 class="text-3xl md:text-4xl font-extrabold text-white">
                Il futuro della scrittura creativa sta per iniziare.
            </h2>
            <p class="text-xl text-neu-text-light font-semibold">
                Vuoi esserci fin dal primo giorno?
            </p>

            <form id="waitlist-form" class="flex flex-col sm:flex-row gap-4 justify-center items-center w-full mt-8"
                onsubmit="event.preventDefault()">
                <div class="w-full sm:w-2/3">
                    <input type="email" placeholder="Il tuo indirizzo email..." required
                        class="w-full bg-neu-base shadow-neu-in rounded-2xl px-6 py-5 outline-none text-neu-text placeholder:text-neu-text-light font-bold text-sm transition-all focus:ring-2 focus:ring-neu-accent/50 border border-transparent" />
                </div>
                <button type="submit"
                    class="w-full sm:w-1/3 px-8 py-5 rounded-2xl font-extrabold text-neu-accent shadow-neu-out hover:shadow-neu-in active:shadow-neu-in transition-all text-sm uppercase tracking-wide">
                    Entra / Waitlist
                </button>
            </form>

            <div class="pt-16 flex flex-col items-center justify-center gap-4 border-t border-white/5 w-1/2 mx-auto">
                <a href="/" class="inline-block opacity-80 hover:opacity-100 transition-opacity">
                    <img src="LogoHorizontal_Alpha.png" alt="Narvis Logo" class="h-6 w-auto grayscale hidden" />
                    <div class="text-3xl font-extrabold tracking-widest text-neu-text opacity-50">
                        <img src="LogoHorizontal_Alpha.png" alt="Narvis Logo" class="h-6 w-auto inline-block" />
                    </div>
                </a>
                <div class="text-xs font-semibold text-neu-text-light tracking-widest uppercase">
                    &copy; 2026. L'ambiente per la tua Narrativa.
                </div>
                <div class="flex gap-6 mt-4 text-xs font-semibold text-neu-text-light/50">
                    <a href="/privacy.html" class="hover:text-neu-accent transition-colors">Privacy Policy</a>
                    <a href="/terms.html" class="hover:text-neu-accent transition-colors">Termini di Servizio</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Simple animation script per l'esordio della hero
        document.addEventListener("DOMContentLoaded", () => {
            setTimeout(() => {
                const typingText = document.getElementById("hero-typing-text");
                const uiElement = document.getElementById("hero-ui-element");

                if (typingText && uiElement) {
                    typingText.classList.remove("opacity-80");
                    typingText.classList.add("opacity-0");

                    setTimeout(() => {
                        uiElement.classList.remove("opacity-0");
                        uiElement.classList.add("opacity-100");
                    }, 500);
                }
            }, 3000);
        });
    </script>

    <!-- Clerk Authentication Integration -->
    <script>
        const publishableKey =
            "pk_test_Ym9zcy1kdWNrbGluZy0yMy5jbGVyay5hY2NvdW50cy5kZXYk";
        const appUrl = "https://narvis-beta.vercel.app/";

        const startClerk = async () => {
            const Clerk = window.Clerk;
            try {
                await Clerk.load();

                const headerBtn = document.getElementById("header-login-btn");
                const heroBtn = document.getElementById("hero-cta-btn");

                if (Clerk.user) {
                    // Se gi√† loggato, i pulsanti portano in app
                    if (headerBtn) {
                        headerBtn.innerText = "Vai all'App";
                        headerBtn.onclick = () => (window.location.href = appUrl);
                    }
                    if (heroBtn) {
                        heroBtn.innerText = "Torna al tuo spazio";
                        heroBtn.onclick = () => (window.location.href = appUrl);
                    }
                } else {
                    // Se ospite, apre il modal di sign in/up in overlay
                    if (headerBtn)
                        headerBtn.onclick = () =>
                            Clerk.openSignIn({ redirectUrl: appUrl });
                    if (heroBtn)
                        heroBtn.onclick = () => Clerk.openSignUp({ redirectUrl: appUrl });
                }
            } catch (err) {
                console.error("Errore inizializzazione Clerk:", err);
            }
        };

        const script = document.createElement("script");
        script.setAttribute("data-clerk-publishable-key", publishableKey);
        script.async = true;
        script.src =
            "https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js";
        script.crossOrigin = "anonymous";
        script.addEventListener("load", startClerk);
        document.body.appendChild(script);
    </script>
    <!-- Script per Drag & Scroll del Carosello -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const container = document.getElementById(
                "features-carousel-container",
            );
            const marquee = document.getElementById("features-marquee");

            let isDown = false;
            let startX;
            let currentScrollLeft = 0;
            let isPaused = false;

            // Funzione per forzare la pausa dell'animazione
            const setPause = (pause) => {
                isPaused = pause;
                if (pause) {
                    marquee.style.animationPlayState = "paused";
                } else {
                    marquee.style.animationPlayState = "running";
                }
            };

            // Mouse Events per il Dragging
            container.addEventListener("mousedown", (e) => {
                isDown = true;
                container.classList.add("active");
                startX = e.pageX - container.offsetLeft;
                setPause(true); // Ferma l'animazione
            });

            container.addEventListener("mouseleave", () => {
                if (isDown) {
                    // Ripristina solo se stava trascinando
                    isDown = false;
                    container.classList.remove("active");
                    setPause(false);
                }
            });

            container.addEventListener("mouseup", () => {
                isDown = false;
                container.classList.remove("active");
                setPause(false); // Riprende l'animazione
            });

            container.addEventListener("mousemove", (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const walk = (x - startX) * 2; // Velocit√† di scrolling drag

                // Mantiene il div in movimento simulando lo scroll nativo tramite transform
                // Per un DOM semplice usiamo scrollLeft
                container.scrollLeft = container.scrollLeft - walk;
                startX = x; // Resetta startX per smooth drag
            });

            // Wheel Events (Rotellina Mouse)
            container.addEventListener("wheel", (e) => {
                e.preventDefault();
                setPause(true);
                container.scrollLeft += e.deltaY; // Trasforma scroll verticale in orizzontale

                // Riprendi animazione dopo una piccola pausa dal momento in cui smetti di scorrere
                clearTimeout(container.scrollTimeout);
                container.scrollTimeout = setTimeout(() => {
                    setPause(false);
                }, 150);
            });

            // Garantisce un loop infinito su scroll manuale (se l'utente arriva in fondo, lo riporta indietro)
            container.addEventListener("scroll", () => {
                const maxScrollLeft = container.scrollWidth - container.clientWidth;
                if (container.scrollLeft >= maxScrollLeft - 5) {
                    container.scrollLeft = 0; // Torna inizio (o met√†) per loop
                } else if (container.scrollLeft <= 0 && isDown) {
                    container.scrollLeft = maxScrollLeft / 2;
                }
            });
        });
    </script>

    <!-- Script Drag & Drop Geometria Storia -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const workspace = document.getElementById("storyline-workspace");
            const svgLayer = document.getElementById("storyline-svg");

            let isDragging = false;

            let currentPath = null;
            let startPort = null;
            let startPortColor = "#06b6d4";
            let startX = 0;
            let startY = 0;

            let hasCreatedNode = false; // Flag per bloccare creazione multipla

            function drawPath(startX, startY, endX, endY, color, pathElement) {
                const dx = Math.abs(endX - startX) * 0.5;
                const d = `M ${startX} ${startY} C ${startX + dx} ${startY}, ${endX - dx} ${endY}, ${endX} ${endY}`;
                pathElement.setAttribute("d", d);
                pathElement.setAttribute("stroke", color);
                pathElement.setAttribute("stroke-width", "2.5");
                pathElement.setAttribute("fill", "none");
                pathElement.style.filter = `drop-shadow(0 0 4px ${color})`;
            }

            function updateInitialLine() {
                // Non disegnamo pi√π la riga verso il vecchio blocco eliminato
                if (initialTarget && initialPort) {
                    //
                }
            }

            // Inizializza layout
            setTimeout(updateInitialLine, 100);
            window.addEventListener("resize", updateInitialLine);

            // --- Normalizzatore Touch/Mouse ---
            const getEventCoords = (e) => {
                if (e.touches && e.touches.length > 0) {
                    return {
                        clientX: e.touches[0].clientX,
                        clientY: e.touches[0].clientY,
                    };
                } else if (e.changedTouches && e.changedTouches.length > 0) {
                    return {
                        clientX: e.changedTouches[0].clientX,
                        clientY: e.changedTouches[0].clientY,
                    };
                }
                return { clientX: e.clientX, clientY: e.clientY };
            };

            const handlePointerDown = (e) => {
                const coords = getEventCoords(e);

                const port = e.target.closest(".connection-port");
                if (port && !hasCreatedNode) {
                    e.preventDefault(); // eviti scroll mobile
                    isDragging = true;
                    startPort = port;
                    startPortColor = port.getAttribute("data-port-color");

                    // Rimuovi eventuale animazione "cue" se presente
                    port.classList.remove("animate-pulse");

                    const portRect = port.getBoundingClientRect();
                    const workspaceRect = workspace.getBoundingClientRect();

                    startX = portRect.left + portRect.width / 2 - workspaceRect.left;
                    startY = portRect.top + portRect.height / 2 - workspaceRect.top;

                    currentPath = document.createElementNS(
                        "http://www.w3.org/2000/svg",
                        "path",
                    );
                    svgLayer.appendChild(currentPath);

                    document.body.style.cursor = "crosshair";
                    return;
                }
            };

            const handlePointerMove = (e) => {
                if (!isDragging) return;

                const coords = getEventCoords(e);
                const workspaceRect = workspace.getBoundingClientRect();
                const mouseX = coords.clientX - workspaceRect.left;
                const mouseY = coords.clientY - workspaceRect.top;

                if (isDragging && currentPath) {
                    e.preventDefault();
                    drawPath(
                        startX,
                        startY,
                        mouseX,
                        mouseY,
                        startPortColor,
                        currentPath,
                    );
                }
            };

            const createNewNode = (x, y, color) => {
                if (hasCreatedNode) return;
                hasCreatedNode = true;

                const uniqueId = "node-" + Date.now();

                // Manteniamo le coordinate nei limiti minimi per non sovrapporsi al blocco principale
                let finalX = x - 20;
                if (finalX < 230) finalX = 230;

                let finalY = y - 40;

                const nodeHtml = `
                <div id="${uniqueId}" class="absolute z-40 draggable-node cursor-grab active:cursor-grabbing hover:ring-2 hover:ring-white/20 transition-[box-shadow_outline] duration-200 rounded-xl" style="left: ${finalX}px; top: ${finalY}px; animation: bounce-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);">
                    <div class="rounded-xl flex flex-col group shadow-neu-in border border-white/20 ring-2 bg-[rgba(224,229,236,0.1)] relative w-64 p-4 gap-3 backdrop-blur-md" style="--tw-ring-color: ${color};">
                        
                        <div class="absolute top-0 left-0 w-full h-4 z-0 rounded-t-xl overflow-hidden pointer-events-none border-b border-white/20 shadow-sm bg-neu-text">
                            <div class="absolute inset-0 w-full h-full" style="background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.2) 10px, rgba(255,255,255,0.2) 20px)"></div>
                        </div>

                        <div class="absolute -top-3 left-4 text-white text-[9px] font-bold px-3 py-0.5 rounded-full shadow-lg z-40 tracking-widest border border-white/20 flex items-center gap-1 pointer-events-none" style="background-color: ${color};">
                            <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            </svg>
                            CHAPTER
                        </div>

                        <h4 class="font-extrabold text-white text-xs uppercase truncate mt-2 pb-2 border-b border-white/10" contenteditable="true" spellcheck="false" title="Clicca per modificare">13. L'Acquario Sottomarino</h4>

                        <!-- Character Proxy -->
                        <div class="rounded-lg bg-neu-base shadow-neu-out border-t border-white/20 relative w-full h-10 flex items-center px-2 gap-2 hover:brightness-110 cursor-text group/edit">
                            <div class="w-6 h-6 rounded-full bg-neu-base-dark shadow-neu-in flex items-center justify-center text-white/50 pointer-events-none shrink-0">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                            </div>
                            <h5 class="font-bold truncate text-xs text-neu-text transition-colors w-full outline-none" contenteditable="true" spellcheck="false">Nemo</h5>
                        </div>

                        <!-- Location Proxy -->
                        <div class="rounded-lg bg-neu-base-dark shadow-neu-in border border-black/20 relative w-full h-10 flex items-center px-2 gap-2 hover:brightness-110 cursor-text group/edit">
                            <h5 class="font-bold truncate text-xs text-neu-text-light pl-2 transition-colors w-full outline-none" contenteditable="true" spellcheck="false">Nautilus</h5>
                        </div>

                        <!-- Zoom Lens Button (Appare dopo creazione) -->
                        <button class="zoom-btn absolute -left-8 top-1/2 -translate-y-1/2 w-8 h-8 bg-neu-accent rounded-full shadow-neu-out flex items-center justify-center text-white hover:scale-110 hover:brightness-110 active:scale-95 transition-all outline-none animate-pulse z-50 group border border-white/20" title="Visualizza la Matrice Narrativa">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line><line x1="11" y1="8" x2="11" y2="14"></line><line x1="8" y1="11" x2="14" y2="11"></line></svg>
                        </button>
                    </div>
                </div>
                `;

                workspace.insertAdjacentHTML("beforeend", nodeHtml);
                const newNode = document.getElementById(uniqueId);
                newNode.classList.add("created-node"); // Helper per CSS

                if (currentPath) {
                    newNode.connectedPath = currentPath;
                    newNode.pathStartX = startX;
                    newNode.pathStartY = startY;
                    newNode.pathColor = color;

                    // Forza il disegno della linea per collegarsi precisamente al punto bloccato (bounded) del nodo
                    drawPath(startX, startY, finalX, finalY + 40, color, currentPath);
                }

                // Logica Zoom Out (Nidificazione)
                const zoomBtn = newNode.querySelector(".zoom-btn");
                zoomBtn.addEventListener("click", (e) => {
                    e.stopPropagation();

                    // Attiva Zoom Out
                    workspace.classList.add("zoomed-out");

                    // Mostra il testo Copy nascosto
                    const wowBox = document.getElementById("wow-description-box");
                    if (wowBox) wowBox.classList.add("expanded");

                    // Rimuovi pulsante
                    zoomBtn.style.display = "none";
                });

                // Fix newline behavior in contenteditable
                const editables = newNode.querySelectorAll("[contenteditable]");
                editables.forEach((el) => {
                    el.addEventListener("keydown", (evt) => {
                        if (evt.key === "Enter") {
                            evt.preventDefault();
                            el.blur();
                        }
                    });

                    // Previeni che il drag scatti dentro l'edit
                    el.addEventListener("mousedown", (e) => e.stopPropagation());
                    el.addEventListener("touchstart", (e) => e.stopPropagation(), {
                        passive: true,
                    });
                });
            };

            const handlePointerUp = (e) => {
                if (isDragging) {
                    const coords = getEventCoords(e);
                    const workspaceRect = workspace.getBoundingClientRect();
                    const mouseX = coords.clientX - workspaceRect.left;
                    const mouseY = coords.clientY - workspaceRect.top;

                    // Solo se stiamo tracciando sufficientemente lontano e dentro l'area bounds destra
                    if (
                        (Math.abs(mouseX - startX) > 40 ||
                            Math.abs(mouseY - startY) > 40) &&
                        mouseX > 200
                    ) {
                        createNewNode(mouseX, mouseY, startPortColor);
                    } else {
                        if (currentPath) currentPath.remove();
                    }
                }

                isDragging = false;
                isDraggingNode = false;
                draggedNode = null;
                startPort = null;
                currentPath = null;
                document.body.style.cursor = "default";
            };

            // Event Listeners Misti (Mouse per Desktop, Touch per Mobile)
            workspace.addEventListener("mousedown", handlePointerDown, {
                passive: false,
            });
            window.addEventListener("mousemove", handlePointerMove, {
                passive: false,
            });
            window.addEventListener("mouseup", handlePointerUp);

            workspace.addEventListener("touchstart", handlePointerDown, {
                passive: false,
            });
            window.addEventListener("touchmove", handlePointerMove, {
                passive: false,
            });
            window.addEventListener("touchend", handlePointerUp);
            window.addEventListener("touchcancel", handlePointerUp);
        });
    </script>

    <!-- Script Logic per World Builder (Sketch-to-Art) -->
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // Elementi UI World Builder
            const fileInput = document.getElementById("wb-file-input");
            const uploadArea = document.getElementById("wb-upload-area");
            const generateBtn = document.getElementById("wb-generate-btn");
            const promptInput = document.getElementById("wb-prompt-input");

            const loader = document.getElementById("wb-loader");
            const splitterStage = document.getElementById("wb-splitter-stage");
            const beforeImg = document.getElementById("wb-before-img");
            const afterImg = document.getElementById("wb-after-img");
            const afterWrapper = document.getElementById("wb-after-wrapper");
            const sliderHandle = document.getElementById("wb-slider-handle");
            const imageContainer = document.getElementById("wb-image-container");

            // Imposta CSS variable per la larghezza reale del container (usata dall'img after per l'effetto before/after)
            const updateContainerWidth = () => {
                const w = imageContainer.offsetWidth;
                imageContainer.style.setProperty("--wb-container-width", w + "px");
            };
            updateContainerWidth();
            window.addEventListener("resize", updateContainerWidth);

            const usesBadge = document.getElementById("wb-uses-badge");
            const signupPrompt = document.getElementById("wb-signup-prompt");

            // API e Stato
            // [SECURITY FIX] La chiave API √® stata rimossa dal frontend. NON METTERLE in chiaro qui, il repo √® pubblico!
            // Da ora in avanti utilizzeremo una Serverless Function di Vercel per mascherarla come variabile d'ambiente.
            const GEMINI_API_KEY = "DA_CONFIGURARE_SU_BACKEND";
            let currentBase64Image = null;
            let currentMimeType = null;

            // Gestione LocalStorage (Limite 2 Usi)
            const MAX_USES = 2; // Usa "narvisdev" nel campo stile per reset illimitato (owner only)
            const STORAGE_KEY = "narvis-wb-demo-uses";

            let usesLeft = localStorage.getItem(STORAGE_KEY);
            if (usesLeft === null) {
                usesLeft = MAX_USES;
                localStorage.setItem(STORAGE_KEY, usesLeft);
            } else {
                usesLeft = parseInt(usesLeft, 10);
            }

            const updateUIState = () => {
                usesBadge.textContent = `${usesLeft}/${MAX_USES} Tentativi`;
                if (usesLeft <= 0) {
                    // Non disabilitare con .disabled: la password deve continuare a funzionare al click
                    generateBtn.classList.add("cursor-not-allowed", "opacity-40");
                    signupPrompt.classList.remove("hidden");
                    usesBadge.classList.replace("bg-neu-base", "bg-red-500/20");
                    usesBadge.classList.replace("text-neu-accent", "text-red-500");
                    return false;
                }
                return true;
            };

            updateUIState();

            // 1. Gestione Caricamento File (Upload Area)
            fileInput.addEventListener("change", (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!file.type.startsWith("image/")) {
                    alert("Per favore carica solo un file immagine (JPG, PNG).");
                    return;
                }

                currentMimeType = file.type;
                const reader = new FileReader();

                reader.onload = (event) => {
                    const fullResult = event.target.result; // "data:image/jpeg;base64,/9j..."
                    beforeImg.src = fullResult;
                    currentBase64Image = fullResult.split(",")[1];

                    // UI Transitions
                    uploadArea.style.display = "none";
                    splitterStage.classList.remove("hidden");

                    // Resetta splitter al default (solo left/before visibility)
                    afterWrapper.style.width = "0%";
                    sliderHandle.style.left = "0%";
                    // Nascondi afterImage per il reset visuale
                    afterImg.src = "";

                    // Abilita bottone solo se ci sono tentativi
                    if (usesLeft > 0) {
                        generateBtn.disabled = false;
                        generateBtn.classList.remove("cursor-not-allowed", "opacity-50");
                    }
                };

                reader.readAsDataURL(file);
            });

            // Permetti click intero box per scatenare l'input
            uploadArea.addEventListener("click", () => {
                // Preveniamo doppio click se gi√† cliccato l'input
            });

            // 2. Costruzione Splitter Logic (Drag To Compare)
            let isDraggingSlider = false;

            const handleSliderMove = (clientX) => {
                const rect = splitterStage.getBoundingClientRect();
                // Calcola % di movimento entro i bounds 0-100
                let percentage = ((clientX - rect.left) / rect.width) * 100;
                percentage = Math.max(0, Math.min(percentage, 100)); // clamp

                sliderHandle.style.left = `${percentage}%`;
                afterWrapper.style.width = `${percentage}%`;
            };

            // Mouse Events
            sliderHandle.addEventListener(
                "mousedown",
                () => (isDraggingSlider = true),
            );
            window.addEventListener("mouseup", () => (isDraggingSlider = false));
            window.addEventListener("mousemove", (e) => {
                if (!isDraggingSlider) return;
                handleSliderMove(e.clientX);
            });

            // Touch Events (Mobile)
            sliderHandle.addEventListener(
                "touchstart",
                () => (isDraggingSlider = true),
                { passive: true },
            );
            window.addEventListener("touchend", () => (isDraggingSlider = false));
            window.addEventListener(
                "touchmove",
                (e) => {
                    if (!isDraggingSlider) return;
                    handleSliderMove(e.touches[0].clientX);
                },
                { passive: true },
            );

            // 3. Generazione Magia AI
            generateBtn.addEventListener("click", async () => {
                const typedValue = promptInput.value.trim();

                // Easter egg: password segreta per reset tentativi (solo owner)
                if (typedValue === "narvisdev") {
                    usesLeft = 999;
                    localStorage.setItem(STORAGE_KEY, usesLeft);
                    promptInput.value = "Concept art cinematografico, altissima qualit√†, illuminazione drammatica";
                    usesBadge.textContent = `${usesLeft}/999 Tentativi`;
                    usesBadge.classList.replace("bg-red-500/20", "bg-neu-base");
                    usesBadge.classList.replace("text-red-500", "text-neu-accent");
                    generateBtn.classList.remove("hidden");
                    signupPrompt.classList.add("hidden");
                    generateBtn.disabled = false;
                    generateBtn.classList.remove("cursor-not-allowed", "opacity-50");
                    return; // non genera l'immagine
                }

                // Generazione reale: richiede immagine caricata
                if (!currentBase64Image) return;
                if (usesLeft <= 0) return;

                const prompt = typedValue || "Concept art cinematico";

                // Aggiorna stato
                generateBtn.disabled = true;
                generateBtn.classList.add("cursor-not-allowed", "opacity-50");
                loader.classList.remove("hidden");
                loader.classList.add("flex");

                // Usa l'SDK ufficiale Google GenAI caricato via ESM (no CORS, uguale a come funziona in Narvis)
                try {
                    const { GoogleGenAI } = await import("https://esm.run/@google/genai");
                    const ai = new GoogleGenAI({ apiKey: GEMINI_API_KEY });

                    const response = await ai.models.generateContent({
                        model: "gemini-2.5-flash-image",
                        contents: {
                            parts: [
                                { inlineData: { mimeType: currentMimeType, data: currentBase64Image } },
                                { text: `Trasforma questo sketch in un capolavoro digital art ultra dettagliato. Stile: ${prompt}. Mantieni la composizione e la struttura originale dello sketch ma renderizzala in modo cinematico, con luci drammatiche e colori ricchi. Ultra HD, altissima qualit√†.` }
                            ]
                        },
                        config: { responseModalities: ["IMAGE"] }
                    });

                    let imageDataUrl = null;
                    if (response.candidates?.[0]?.content?.parts) {
                        for (const part of response.candidates[0].content.parts) {
                            if (part.inlineData) {
                                imageDataUrl = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                                break;
                            }
                        }
                    }

                    if (!imageDataUrl) throw new Error("Nessuna immagine generata dalla API.");

                    afterImg.style.filter = "none";
                    afterImg.src = imageDataUrl;

                    // Aggiorna counter
                    usesLeft -= 1;
                    localStorage.setItem(STORAGE_KEY, usesLeft);
                    updateUIState();

                    // Nascondi loader e anima splitter
                    loader.classList.add("hidden");
                    loader.classList.remove("flex");

                    sliderHandle.style.transition = "left 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
                    afterWrapper.style.transition = "width 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
                    sliderHandle.offsetHeight;
                    sliderHandle.style.left = "50%";
                    afterWrapper.style.width = "50%";

                    setTimeout(() => {
                        sliderHandle.style.transition = "none";
                        afterWrapper.style.transition = "none";
                    }, 800);

                    if (usesLeft > 0) {
                        generateBtn.disabled = false;
                        generateBtn.classList.remove("cursor-not-allowed", "opacity-50");
                    }

                } catch (err) {
                    console.error("Generazione immagine fallita:", err);
                    loader.classList.add("hidden");
                    loader.classList.remove("flex");
                    generateBtn.disabled = false;
                    generateBtn.classList.remove("cursor-not-allowed", "opacity-50");
                    alert("Errore generazione immagine: " + err.message + "\n\nAssicurati che la API key sia abilitata per 'Generative Language API' su Google Cloud Console.");
                }
            });
        });
    </script>
    <style>
        /* Zoom Out Mode Classes */
        #storyline-workspace.zoomed-out .node-element,
        #storyline-workspace.zoomed-out .created-node {
            opacity: 0 !important;
            transform: scale(0.3) !important;
            pointer-events: none !important;
            filter: blur(2px) grayscale(100%);
        }

        #storyline-workspace.zoomed-out #storyline-svg {
            opacity: 0 !important;
        }

        #storyline-workspace.zoomed-out #abstract-graph-overlay {
            opacity: 1 !important;
            transform: scale(1) !important;
        }

        #wow-description-box.expanded {
            max-height: 800px !important;
            opacity: 1 !important;
        }

        @keyframes bounce-in {
            0% {
                transform: scale(0.8);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        [contenteditable="true"] {
            outline: none;
            cursor: text;
        }

        [contenteditable="true"]:focus {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
    </style>
</body>

</html>